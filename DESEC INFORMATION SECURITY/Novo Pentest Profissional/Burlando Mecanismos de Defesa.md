
## Bypass Firewall
*Utilizando host da VPN (172.16.1.5)*

Temos um firewall restritivo que não nos permite realizar o scan das portas da máquina.

Uma opção que podemos utilizar é especificar uma porta por qual estará sendo realizada o scan, pois o firewall pode ter sido configurado para deixar passar pacotes de uma porta específica por exemplo, a porta 53
```shell
nmap -v -sS -Pn --source-port 53 172.16.1.5
#--source-port ou -g : porta de origem dos scans
```

Conseguimos fazer o scan na rede, mas como acessar agora o serviço que está em alguma porta? Sendo que nossas requisições estão sendo barradas pelo firewall?

-> Podemos utilzar o *netcat* para definir uma porta de origem da conexão que queremos fazer:
```shell
nc -vn -p 53 172.16.1.5:8180
```
-> Junto disso podemos obter o conteúdo por trás dessa porta utilizando uma espécie de "clonagem" onde fazemos uma requisição GET e salvamos seus conteúdos em uma file
```shell
nc -vn -p 53 172.16.1.5:8180 > bloqueado.html

#DENTRO DA CONEXÃO
GET / HTTP/1.0


```
-> Com isso podemos abrir esse arquivo e visualizar(não perfeitamente) o que está acontecendo naquela porta 


## IDS-Sistemas de Detecção de Intruso
*Sistemas com função de ALERTAR ataques na rede*

****SEGUIR PDF POIS A AULA FOI COM O SNORT v2 e no v3 MUDOU MUITA COISA***
[[Snortv2 x Snortv3 - NPP.pdf]]

**Existem os IPS que são sistemas de prevenção de detenção de intrusos, que fazem uma ação ativa para parar o atacante**

Podem alertar o adminstrador do sistema fazendo com que ele te bloqueie, veja oque está ocorrendo, tire o serviço explorado do ar, etc.

Eles funcionam a base de regras, tornado de extrema importância entender como funcionam para se evadir deles.

###### Como funcionam
*Usado o snort como demosntração*

Possuem o arquivo de configuração e uma pasta de rules, que podem ser modificadas, removidas, adicionadas.

Usando:
``` shell
snort -A fast -q -h ("sua rede") -c "Arquivo de configuração" 
#ligra o snort na rede utilizando o seu arquivo.conf
#-q : quiet mode (menos poluente na tela)
# -A fast : modo de alerta
```
Dentro de ```/var/log/snort``` temos acesso aos logs de tudo o que esta acontecendo na rede 


#### Entendendo e criando regras de IDS

Vamos criar uma regra customizada para poder aprender como elas funcionam

*Exemplo de Regra Simples:*
![[Pasted image 20250220225622.png]]

```shell
# criar o nosso arquivo de regras
nano desec.rules

# criar regras 
alert tcp any any -> 192.168.0.11 any (msg:"Possível Port Scanning";sid:1000001;rev:001;)
# ir mudadno o sid e rev de acordo que voce for criando suas regras e alterando 
# elas 

#segunda regra para alertar sobre pacotes SYN na porta 22
alert tcp any ant -> 192.168.0.11 22 (msg:"Pacote SYN enviado ao SSH";flags:S;sid:1000002;rev:001;)

#terceira regra para avisar caso acesso o arquivo robots.txt no web server
alert tcp any any -> 192.168.0.11 80 (msg:"Acesso ao robots.txt";context:"robots.txt";rid:1000003;rev:001;)

#linkar ela no arquivo .conf
cd /etc/snort
nano snort.conf

#adicionar nossa regra no arquivo 
include $RULE_PATH/desec.rules

#salvar e habilitar o snort novamente
snort -A console -q -h 192.168.0.0/24 -c snort.conf
```




## Bypass de regras IDS
*Aula com viés de aprender a estudar sobre as regras para que no futuro não siga receita de bolo e consiga desenvolver a própia pesqusia sobre as coisas*

Observando as regras do snort foi possível obter a informação que uma das regras de análise de ICMP se baseava no conteúdo dentro do pacote ICMP, onde apenas alterando seu payload conseguimos burlar essa regra e passar por ela

**Report Inicial Snort:**
![[Pasted image 20250220231541.png]]

-> Regra mostrando que usa o content: como via de medição
![[Pasted image 20250220231401.png]]-> Enviando pacote com payload diferente:
![[Pasted image 20250220231428.png]]

**Report após a mudança de payload:**
![[Pasted image 20250220231626.png]]

-> Podemos perceber que ele tem mais duas regras, procurando pela próxima regra e pensando em uma maneira de burlar ela:
*Usamos o grep -r "ICMP Ping" para procurar em todo o diretório de regras*

-> Encontrando a regra podemos ler ela e ver que ela utiliza o "icode:0" como um parâmetro de medição, podemos tentar alterar tal parâmetro em nosso ping para burlar esta regra
![[Pasted image 20250220232001.png]]
-> Enviando pacote com código diferente 
![[Pasted image 20250220232150.png]]
*Utilziamos o hping3 pois ele é mais fácil de alterar o código que é enviado*

**Resposta após mudança do código:**
![[Pasted image 20250220232254.png]]*ICMP Ping não apareceu mais,porém aparece uma outra regra sobre código indefinido*

-> Outra regra que possuimos é o ICMP PING NMAP,procurando ela nos arquivos conseguimso notar que ela é baseada no tamanho do pacote:
![[Pasted image 20250220232449.png]]
-> Alterando o tanto de data que enviamos para dar o bypass na regra:
![[Pasted image 20250220232531.png]]
**Resposta após a mudança do tamanho:**
![[Pasted image 20250220232632.png]]



## IPS / Bloqueio de Port Scanning 
*Técnica para bloquear o atacante quando detectar um port scanning*

Usaremos o seguinte raciocínio: 
-> Instalar um aplicativo que cria e abre diversas portas falsas na sua máquina
*aplicativo: portsentry*
-> Detectamos o atacante escaneando as portas falsas
-> Realizamos o bloqueio do atacante

- Acessar o arquivo de configurações do portsentry, e podemos habilitar nele mesmo para quando detectar um atacante ele mesmo realizar um bloquei de tcp ou udp ou até mesmo da rota 
- portsentry pode ser utilizado e reconfigurado para bloquear até mesmo scans mais silenciosos como o Syn Scan

**Caso receba no scan do nmap um tcpwrapped ficar atento pois muito provavelmente o ambiente está lhe detectando**

## Bypass IDS/IPS/FW

*Agora que vimos vários mecanismos de defesas e como funcionam vamos ver como burlar e dar o bypass em tais mecanismos*  

A técnica que podemos utilizar é a de mascarar nossos pacotes maliciosos que vão ser utilizados para dar o scan na rede ou o envio de payloads junto de pacotes normais, fazendo com que os mecanismos de defesa não saibam qual pacote "prender" ou não consigam "prender" o pacote devido a grande quantidade de pacotes

*Nosso ambiente terá o portsentry configurado para bloquear qualquer tipo de scanning e uma regra do snort para qualquer tráfego tcp*

-> Podemos começar de uma maneira mais furtiva como atacantes, utilizando o Syn Scan e fazendo a varredura apenas em *top ports* diminuindo assim o nosso "risco" e mudando o tempo de cada scan um entre o outro
```shell
nmap -v -sS --top-ports=10 --open -Pn 192.168.0.11
# este scan foi com sucesso devido a estarmos utilizando um método mais furtivo com as top 10 portas
nmap -v -sS --open -Pn 192.168.0.11
#neste caso tivemos nossa conexão bloqueada pois o port sentry detectou nosso scan em portas fakes NESSA CONFIGURAÇÃO(Cuidar que podem configurar top ports como fake)
```

-> Para realizar a técnica falada acima utilizaremos a flag **-D**(decoy) do nmap que fará exatamente o que foi dito, enviando vários pacotes para mascarar nosso pacote de scan
``` shell

nmap -v -sS -D 10.12.2.34,10.65.4.87,90.56.78.104 --open -Pn 192.168.0.11
# foi enviado diversos pacotes com endereços ip's falsos que fizeram a nossa camuflagem junto do scan permitindo assim que conseguissemos dar um bypass nos mecanismos de defesa
```
-> Para tornar isto mais eficiente podemos usar MAIS endereços ip's para nos camuflar e ajudar no scan mais ainda, podemos fazer isso passando o RND para a flag da seguinte maneira:
```shell
nmap -v -sS -D RND:20 -sS -Pn 192.168.0.11
# enviar usando 20 enderços ip's aleatórios
```
