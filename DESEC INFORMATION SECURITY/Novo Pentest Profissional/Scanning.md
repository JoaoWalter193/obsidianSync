O scanning é a fase onde será descoberto o que o host está rodando, quais protocolos aceita e não aceita, o Sistema Operacional, etc. É a fase que vai dar o futuro do pentest no alvo

----------------------------------------------------------------------


## Tracing Route

-> Identificar a rota que os pacotes fazem até chegar no alvo
-> Identificar possíveis filtros e bloqueios
-> Identificar quais pacotes são aceitos

###### Como funciona?
Podemos utilizar o TTL para fazer o tracking, fazendo um tracking usando TTL 1, para o primeiro roteador, TTL 2 para o segundo e assim por diante, pois quando o TTL "morre" ele retorna  ICMP de tipo 11 e de código 0

![[Pasted image 20250220102454.png]]

###### Exemplo na prática
![[Pasted image 20250220104342.png]]

\* depois ou antes do TTL (linha 12) significa que o roteador demorou mais de 3seg para responder o pacote (2 \* = 6s)
\*** indica que provavelmente aquele roteador não aceita este protocolo(nesse caso UDP)

Podemos mudar o protocolo para o traceroute, para desobrirmos que pacotes o host aceita

![[Pasted image 20250220105036.png]]*Utilizado o -I para enviar via protocolo ICMP*


## Overview sobre Firewall

*Cenário para o aprendizado será sob a VPN da Desec Security*
Alvo: 172.16.1.5


-> Aplicando o *nmap* antes das regras do firewall no host podemos ver as inúmeras portas abertas que ele possui
![[Pasted image 20250220112043.png]]

Agora podemos passar para a configuração do iptables

iptables -nL -> Mostrar as regras do firewall

iptables -F -> Zerar as regras (mas não altera as políticas)

iptables -P -> Politica que vai aplicar
Ex: iptables -P INPUT DROP (faz com que tudo que for entrar dar DROP)

iptables (oque quer fazer) -s(ip) -> configura o source, se colocar em alguma regra vai permitir ou bloquear apenas aquele ip

Regra para liberar a conexão HTTP:
iptables -A INPUT -p tcp --dport 80 -j ACCEPT -> Faz com que a porta 80 aceite o protocolo tcp (-A append INPUT, -p o protocolo, --dport 80 na porta 80, -j oque vai fazer )

Regra para liberar o ICMP:
iptables -A INPUT -p icmp -j ACCEPT -> Vai aceitar em qualquer porta desde que seja o protocolo ICMP


## Ping Sweep

Técnica para descobrir hosts ativos em uma rede, válido para pentest externo e interno

Se baseia em enviar um ping e esperar uma resposta(ñ levar totalmente a verdade caso o host não responda, pois podem existir firewalls e outras coisas bloqueando).
Realizado previamente em outro módulo usando um simples script:
```shell
for ip in $(seq 1 225); do ping -c 1 (ip).$ip -w 1; done | grep "64 bytes"
```
Existem ferramentas para automatizar e agilizar esse processo como o **fping**


## Achando hosts ativos através do ARP
**Técnica para pentest interno(conectado em um ponto de rede, cabo ou wireless)**

Poderíamos utilizar o **arping**, ferramenta parecida com o ping, porém irá utilizar do protocolo ARP para fazer as chamadas. Esses comando pode ser utilizado assim como o script de pings criado anteriormente:
```shell
for ip in $(seq 1 225); do arping -c 1 (ip).$ip; done | grep "60 bytes"
```



## Nmap para hosts ativos
Ferramenta de port-scanning mais antiga e conhecida para fazer o reconhecimento de rede, ele por exemplo, pode ser utilizado para substituir o ping sweep caso exista algum firewall ou programa bloqueando a entrade de protocolos ICMP

Podemos utilizar a tag **-sn** para fazer a identificação dos hosts em rede:
```nmap -sn (ip ou range de ip's) ```


## Port Scanning
Mapeamento de portas de um host, podendo descobrir quais serviços estão rodando em determinadas portas

###### Serviço Ativo:
![[Pasted image 20250220125042.png]]

###### Serviço Inativo:
![[Pasted image 20250220125115.png]]


Quando fazemos o scan com a ferramenta do nmap, podemos ver que temos 3 respostas possíveis:

-> Open : Porta aberta pois foi realizada a SYN/ACK
-> Closed : Porta fechada pois foi realizada o RST/ACK
-> Filtered :  A porta está protegida atrás de um firewall, ou negando ou ignorando as requisições.
*Obs: Ficar atento pois o firewall pode lhe dar um falso-negativo, pois o firewall ordenou que as requisições que recebessem nessa porta fossem devolvidas com um RESET*

![[Pasted image 20250220130752.png]]

##### Diferença entre os tipos de SCAN

Vários tipos porém 2 mais utilizados no dia a dia(outros não sao tão confiáveis)

###### TCP Connect

-> Completa o three-way handshake
-> Gera muito "barulho" pois tenta TWH em várias portas, logo fácilmente detectável
-> Consumo maior de tráfego na rede
![[Pasted image 20250220131133.png]]
-> Após o handshake manda um RESET para fechar a comunicação



###### Half Open/ Syn Scan

-> Não completa o three-way-handshake
-> É mais furtivo que o TCP Connect, pois não envia todos os pacotes
-> Consome menos tráfego de rede



## Metodologia Scanning

Necessita ter métodos e técnicas para fazerem os scans de maneira otimizada, salvando seu tempo e de quem o contratou para o trabalho, focando nas partes principais e mais problemáticas

----
#### Processo

-> TCP HOST SCAN == Identificar todas as portas abertas (TCP)
-> UDP HOST SCAN == Identificar todas as portas abertas (UDP)
-> NETWORK SWEEPING == Identifficar todas as portas abertas na rede de forma otimizada

#### Desafios

-> Tempo de Scan e consumo do tráfego
-> Firewall filtando/ Rejeitando pacotes
-> Bloqueios de portscan
-> Sistemas de detecção e prevenção de intrusos(IDS/IPS)






#### TCP HOST SCAN
Ideia é identificar todas as portas TCP's que estão presentes no alvo
Necessitamos fazer o scan de todas as portas (nmap padrão scanneia apenas as 1000)
Podemos utilizar a flag **-p-** para informar para o nmap realizar o scan em todas as portas
Uso:
```shell
nmap -v -sS -p- -Pn ("ip do alvo")
# -v : modo verboso
# -sS : Utiliza o modo de scan Syn Scan
# -p- : Scannear todas as portas
# -Pn : Não verificar se o host está up
```


#### UDP HOST SCAN
A varredura de UDP é tão importante quanto a do TCP, pois muitos programas e serviços utilizam o protocolo UDP para a comunicação onde ás vezes existe alguma falha que pode ser explorada.
Um dos desafios do UDP é sua ambiguidade, onde realizando o scan, caso ela esteja aberta ou com configuração de DROP no firewall não lhe traz resposta, e quando a porta está aberta ou com configuração de REJECT no firewall ele traz a porta como unreachable.

Como podemos superar esse desafio?
-> O nmap possui a flag -V que após realizar o scan ele tenta usar scripts para reallizar o scan e descobrir se a porta está aberta ou com algum block de firewall
```shell
nmap -v -sUV -p ("porta/as") ("ip do host")
# -sUV : Realizar o scan por UDP e apos utilizar os scripts para validação
```


#### Networking Sweeping
Forma mais eficiente de varrer uma rede maior onde ainda não se conhece todos os hosts e quais possam apresentar serviços vulneráveis rodando para serem explorados.

-> 1º Passo: Scannear a rede e descobrir quais hosts estão ativos em uma rede
``` shell
nmap -v -sn ("ip da rede/netmask") -oG hosts.txt
# -sn : fazer o scan de hosts para saber se estão up ou down
# -oG : Gerar um output de uma maneira mais legível
```
-> Agora temos todos os hots podemos fazer uma filtagrem de quais estão ativos e usar isso para realizar o Scan da rede
```shell
cat hosts.txt | grep "UP" | cut -d " " -f2 > hostsAtivos.txt
# criada file com apenas os hosts ativos da rede
```
-> Com uma lista de apenas os ativos conseguimos scannear de forma mais precisa quais hosts possuem serviços ativos neles
```shell
nmap -sSV -p ("porta/as") --open -Pn -iL hostsAtivos.txt -oG serviços.txt
# --open : mostrar apenas as respostas open
# -sSV : Utiliza os scripts para realizar um banner grabbing
# -iL utilizar uma file para os ip's
```

#### Identificando Serviços

Agora que temos as portas abertas, precisamos descobrir quais os serviços que estão nessas portas para saber se podemos nos aproveitar disto ou não.

Quando realizamos o scan normal com o nmap, ele nos traz uma coluna de SERVICE, porém ele não realiza a identificação do serviço, ele apenas tem uma lista salva de nomes de serviços que usam aquela porta. 
Para podermos descobrir de verdade qual serviço está rodando em uma determinada porta podemos utilizar a flag **-sV** que conecta e tenta extrair as versões e informações do serviço (banner grabbing).
Uso: 
```shell
nmap -sV -sS -v ("ip alvo")
# -sV : Utiliza scripts para interagir com o protocolo/entrar nele e pegar
# o banner
```


## Serviços Falsos

Temos que tomar cuidado para não ser enganado por serviços onde tem a porta alterada, possuem um honeygrabber, por isso devemos analisar meticulosamente os serviços e sempre garantir qual serviço está rodando em qual porta.

Junto disso o administrador do serviço pode alterar o banner do serviço para proteger o sistema e enganar o atacante.
Tal ajuste pode ser feito pela ferramenta bless, um editor hexadecimal, onde podemos modificar o binário de um serviço e alterar da maneira como queremos
**CUIDADO! CONSIDERADO UMA GAMBIARRA, SALVAR UMA CÓPIA DO SERVIÇO ORIGINAL**


## OS Fingerprinting
*Técnicas para identificar o sistema operacional (SO)*

-> Uma das técnicas mais utilizadas para descobrir qual o SO da máquian é o TTL, onde cada sistema vem com um TTL configurado de forma diferente.
![[Pasted image 20250220220155.png]]

-> Análise de serviços especiais(Remote Desktop(3389) / SSH (22) / WEBSERVER)
-> Implementação da pilha TCP/IP
-> Enumeração dos serviços identificados
-> Nmap -O / -A



