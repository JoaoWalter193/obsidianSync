

## Introdução

Scapy é uma ferramenta para manipulação de pacotes de maneira interativa, pode ser utilizado como uma ferramenta ou uma biblioteca de Python, onde é muito utilizado para a criação de scripts e ataque de vulnerabilidades. 
Por isso é de extrema importância ter noção de como o scapy funciona e de como podemos utilizar ele ao nosso favor.

###### *Descrição no man:*
**scapy** is a powerful interactive packet manipulation tool, packet generator, network scanner, network discovery, packet sniffer, etc. It can for the moment replace hping, parts of nmap, arpspoof, arp-sk, arping, tcpdump, tshark, p0f, ...

**scapy** uses the python interpreter as a command board. That means that you can use directly python language (assign variables, use loops, define functions, etc.) If you give a file as parameter when you run **scapy**, your session (variables, functions, intances, ...) will be saved when you leave the interpretor, and restored the next time you launch **scapy**.

The idea is simple. Those kind of tools do two things : sending packets and receiving answers. That's what **scapy** does : you define a set of packets, it sends them, receives answers, matches requests with answers and returns a list of packet couples (request, answer) and a list of unmatched packets. This has the big advantage over tools like nmap or hping that an answer is not reduced to (open/closed/filtered), but is the whole packet.

On top of this can be build more high level functions, for example one that does traceroutes and give as a result only the start TTL of the request and the source IP of the answer. One that pings a whole network and gives the list of machines answering. One that does a portscan and returns a LaTeX report.

###### Usage:
Digitando scapy no terminal você entra no modo interativo dele.

Digitando **lsc()** você poderá ver todos os comandos disponíveis junto de uma breve descrilção do que cada comando faz
Caso queira informações mais detalhadas sobre um comando, digitar **help(comando)**

Digitando **ls**() ele mostra todos os protocolos que suporta, colocando um dos protocolos nos parênteses você consegue maior descrição sobre o protocolo listado 

## Manipulando Pacotes de Rede

*Estaremos dentro do modo interativo do Scapy*

Podemos criar uma variável e definir os seus valores de acordo com cada protocolo

``` Python

ls(IP)
#mostra as opções do protocolo

pIp = IP(dst="ip de destino")

pIp
# Output: <IP dst="ip colocado" |>

pIP.show()
# Mostra as configurações presentes dentro da variável

pTCP= TCP(dport=80,flags = "S")
pTCP = TCP(dport=[80,443,8080,])
#altera para uma lista d portas


#para alterar dados presentes no protocolo basta apenas usar o seguinte
variável.protocolo = "informação"

#agora vamos criar um pacote para fazer o encapuslamento do nosso protocolo TCP no IP
pacote = pIP/pTCP


#Enviar pacotes:

sr1(pacote)
#faz o envio de 1 pacote

sr(pacote)
#faz o envio de múltiplos pacotes

#podemos também guardar os resultados do envio de pacote em uma variável,
#para facilitar o manejo e a saída do programa
resp,noresp = sr(pacote)
# gravou os resultados nas variáveis resp e noresp(coisas que deram ruim)

#podeos ver um sumario ou msotrar tudo das respsostas com os comandos
resp.show()
resp.summary()
```



## Criando pacotes ICMP e payloads

*utilizando as variáveis/interface utilizada na sessão acima*

``` Python

pacote = pIP/ICMP()

respota = sr1(pacote)

# adicionando payload no pacte
pacote = pIP/ICMP()/"DESEC SECURITY"
pacote = pIP/pTCP/"DESEC SECURITY"
```


## Portscan com o scapy

Vamos criar um portscan com python que utiliza o scapy

```Python
#!/usr/bin/python
import sys
from scapy.all import *

conf.verb = 0
#não exibe mais o output padrao que o scapy produz

portas=[21,22,23,25,80,443,110]

pIP = IP(dst=sys.argv[1])
pTCP = TCP(dport=portas,flags="S")
pacote = pIP/pTCP
#resp[0][0]
#1 [] = qual pacote vai ser mostrado
#2 [] = se vai ser o pacote de resposta ou de enviof
resp,noresp = sr(pacote)
for resposta in resp:
	porta = resposta[1][TCP].sport
	flag = resposta[1][TCP].flags
	if (flag=="SA"{
		print ("Porta %d Aberta" %porta )
```


## Pingscan com o scapy

```Python


from scapy.all import *
conf.verb=0
print "Hosts Respondendo Ping:"
for ip in range(1,255):
	iprange="192.168.0.%s" %ip
	pIP = IP(dst=iprange)
	pacote = pIP/ICMP()
	resp,noresp = sr(pacote)
	for resposta in resp:
		print reposta[1][IP].src
		#[1] pois quero o pacte de retorno
```


